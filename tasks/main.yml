---
- name: Check if Exchange is installed
  win_service:
    name: "MSExchangeFrontendTransport"
  register: exchange_installed

- name: End the play if Exchange is already installed
  ansible.builtin.meta: end_host
  when: exchange_installed.exists
  
- name: Download Exchange ISO for Windows Server 2016
  ansible.builtin.include_tasks: ludus-download-exchange-2016.yml
  when: ludus_os_version == "2016"

- name: Download Exchange ISO for Windows Server 2019
  ansible.builtin.include_tasks: ludus-download-exchange-2019.yml
  when: ludus_os_version in ["2019", "2022"]

- name: Ludus Exchange Server features to be installed
  ansible.builtin.include_tasks: ludus-exchange-pre.yml

- name: Install Exchange Server
  ansible.builtin.include_tasks: ludus-exchange-install.yml